name: ğŸ§¬ Surgical Self-Repair

on:
  workflow_dispatch:
    inputs:
      target_file:
        description: 'The full path of the commander file to be repaired (e.g., .github/workflows/genesis_commander.yml)'
        required: true
      new_content_b64:
        description: 'The new Base64 encoded content for the file'
        required: true

jobs:
  apply_surgery:
    runs-on: ubuntu-latest
    steps:
      - name: Perform Genetic Surgery
        env:
          GH_TOKEN: ${{ secrets.COMMANDER_PAT }}
          # Ø§Ø³ØªØ¨Ø¯Ù„ 'avatar-template' Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ø¯
          COMMANDER_REPO: "avatar-template" 
          TARGET_FILE: ${{ github.event.inputs.target_file }}
          NEW_CONTENT: ${{ github.event.inputs.new_content_b64 }}
        run: |
          echo "Starting surgical procedure on commander: $COMMANDER_REPO"
          
          # 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ SHA Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù…Ù†
          SHA=$(gh api /repos/${{ github.repository_owner }}/$COMMANDER_REPO/contents/$TARGET_FILE --jq '.sha')
          
          if [ -z "$SHA" ]; then
            echo "FATAL: Could not retrieve SHA for target file. Surgery aborted."
            exit 1
          fi
          
          # 2. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø¬Ø±Ø§Ø­ÙŠ
          gh api --method PUT /repos/${{ github.repository_owner }}/$COMMANDER_REPO/contents/$TARGET_FILE \
            -f message="ğŸ§ âœ¨ Commander Self-Correction via Surgical Repair" \
            -f content="$NEW_CONTENT" \
            -f sha="$SHA"
            
          echo "Surgery complete. The commander has evolved."
