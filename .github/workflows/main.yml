name: ğŸ§¬ GENESIS COMMANDER

on:
  workflow_dispatch:

jobs:
  genesis_learning_cycle:
    runs-on: ubuntu-latest
    steps:
      # 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Øª
      - name: 1.1 - Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMANDER_PAT }}

      - name: 1.2 - Setup Environment
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          mkdir -p knowledge_base

      # 2. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Gemini (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø°ÙŠ Ø£Ø«Ø¨Øª Ù†Ø¬Ø§Ø­Ù‡ ÙÙŠ ØªÙŠØ±Ù…ÙƒØ³)
      - name: 2.1 - Gemini Generation
        id: gemini_task
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          KNOWLEDGE=$(find knowledge_base -maxdepth 1 -name '*.py' -print0 | xargs -0 cat 2>/dev/null || echo "Initial lesson.")
          PROMPT="You are an AI teacher. Current knowledge: $KNOWLEDGE. Provide ONLY the next Python lesson code. No markdown, no explanations. Just raw code."
          JSON_DATA=$(jq -n --arg p "$PROMPT" '{contents: [{parts: [{text: $p}]}]}')

          # Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø°ÙŠ Ù†Ø¬Ø­ Ù…Ø¹Ùƒ
          API_URL="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent"
          
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "x-goog-api-key: ${GOOGLE_API_KEY}" \
            -d "$JSON_DATA" \
            "$API_URL")

          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆØ¯ ÙˆØªÙ†Ø¸ÙŠÙÙ‡
          TASK_CODE=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty' | sed -e 's/^```python//' -e 's/^```//' -e 's/```$//' | sed '/./,$!d')

          if [ -z "$TASK_CODE" ] || [ "$TASK_CODE" == "null" ]; then
            echo "âŒ Error: API Response failed."
            echo "$RESPONSE"
            exit 1
          fi
          
          echo "task_payload<<EOF" >> $GITHUB_ENV
          echo "$TASK_CODE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ù…Ù†ÙØ° (Executor)
      - name: 3.1 - Dispatch Task to Executor
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: executor.yml
          repo: 246248m-hub/phoenix-executor
          token: ${{ secrets.COMMANDER_PAT }}
          inputs: >
            {
              "task_payload": ${{ toJson(env.task_payload) }},
              "commander_repo": "${{ github.repository }}",
              "run_id": "${{ github.run_id }}"
            }

      # 4. Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¯Ø±Ø³ ÙˆØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
      - name: 4.1 - Archive Knowledge & Update README
        if: success()
        run: |
          LESSON_NUM=$(($(find knowledge_base -maxdepth 1 -name '*.py' | wc -l) + 1))
          echo "${{ env.task_payload }}" > "knowledge_base/lesson_${LESSON_NUM}.py"
          
          # ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù Ø§Ù„Ù€ README Ù„ÙŠÙƒÙˆÙ† Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ…
          cat << EOF > README.md
          # ğŸ§  PHOENIX KNOWLEDGE BASE
          
          ## ğŸ“Š Learning Progress
          - **Total Lessons:** $LESSON_NUM
          - **Last Update:** $(date -u)
          - **Status:** ğŸŸ¢ Active & Learning
          
          ## ğŸ“š Latest Skill Acquired
          The AI has archived \`lesson_${LESSON_NUM}.py\`.
          
          ---
          *Auto-generated by Genesis Commander*
          EOF
          
          git config --global user.name 'Genesis Teacher'
          git config --global user.email 'bot@github.com'
          git add .
          git commit -m "Learned: Lesson ${LESSON_NUM}"
          git push || echo "No changes to commit"

      # 5. Ø§Ù„Ø¥Ø­ÙŠØ§Ø¡ Ø§Ù„Ø°Ø§ØªÙŠ (Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ 5 Ø¯Ù‚Ø§Ø¦Ù‚)
      - name: 5.1 - Resurrect
        if: always()
        run: |
          echo "Waiting 300s to protect API quota..."
          sleep 300
          curl -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.COMMANDER_PAT }}" \
            [https://api.github.com/repos/$](https://api.github.com/repos/$){{ github.repository }}/actions/workflows/genesis_commander.yml/dispatches \
            -d '{"ref":"main"}'