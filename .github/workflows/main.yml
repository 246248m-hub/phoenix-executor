name: ğŸ§¬ GENESIS COMMANDER (The Adaptive Brain)

on:
  workflow_dispatch:
    inputs:
      custom_objective:
        description: 'Ø¥Ø¯Ø®Ø§Ù„ Ù‡Ø¯Ù Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ ØªØºÙŠÙŠØ± Ù…Ø³Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        default: 'Continue building yourself from first principles.'

jobs:
  genesis_learning_cycle:
    runs-on: ubuntu-latest
    steps:
      - name: 1.1 - Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMANDER_PAT }}

      - name: 1.2 - Setup Environment
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          mkdir -p knowledge_base

      - name: 2.1 - Adaptive Generation (Gemini 2.5)
        id: gemini_task
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          USER_INPUT: ${{ github.event.inputs.custom_objective }}
        run: |
          # Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø±ÙØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
          KNOWLEDGE=$(find knowledge_base -maxdepth 1 -name '*.py' -print0 | xargs -0 cat 2>/dev/null || echo "Empty state.")
          
          # Ø¨Ù†Ø§Ø¡ Ø¨Ø±ÙˆÙ…Ø¨Øª "Ø§Ù„ØªÙƒÙŠÙ Ø§Ù„Ù…Ø·Ù„Ù‚"
          # Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª ÙŠØ¬Ø¹Ù„ Gemini ÙŠØ­Ù„Ù„ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙŠÙ‚Ø±Ø± Ù…Ø§ ÙŠØ­ØªØ§Ø¬Ù‡ Ø§Ù„Ù…Ù†ÙØ° (Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† ÙƒÙˆØ¯ Ø¨Ø±Ù…Ø¬ÙŠØŒ Ø£Ø¯Ø§Ø©ØŒ Ø£Ùˆ ÙØ­Øµ Ù†Ø¸Ø§Ù…)
          PROMPT="You are an autonomous AI core. 
          Current Objective: $USER_INPUT
          Current Knowledge/Context: $KNOWLEDGE
          
          Your Task: Define the next immediate action to take. 
          - If the objective requires a new skill, provide the Python code to learn it.
          - If the objective is a command, provide the Python script to execute it.
          - ALWAYS include '# REQUIREMENTS: library1 library2' if external tools are needed.
          - Respond ONLY with raw Python code. No markdown, no talk."

          JSON_DATA=$(jq -n --arg p "$PROMPT" '{contents: [{parts: [{text: $p}]}]}')
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø°ÙŠ ÙŠØ¹Ù…Ù„ Ù„Ø¯ÙŠÙƒ
          API_URL="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent"
          
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "x-goog-api-key: ${GOOGLE_API_KEY}" \
            -d "$JSON_DATA" \
            "$API_URL")

          TASK_CODE=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty' | sed -e 's/^```python//' -e 's/^```//' -e 's/```$//' | sed '/./,$!d')

          if [ -z "$TASK_CODE" ] || [ "$TASK_CODE" == "null" ]; then
            echo "âŒ Critical Error: No response from Brain."
            exit 1
          fi
          
          echo "task_payload<<EOF" >> $GITHUB_ENV
          echo "$TASK_CODE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: 3.1 - Dispatch to Universal Executor
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: executor.yml
          repo: 246248m-hub/phoenix-executor
          token: ${{ secrets.COMMANDER_PAT }}
          inputs: >
            {
              "task_payload": ${{ toJson(env.task_payload) }},
              "commander_repo": "${{ github.repository }}",
              "run_id": "${{ github.run_id }}"
            }

      - name: 4.1 - Archive & Sync Dashboard
        if: success()
        run: |
          LESSON_NUM=$(($(find knowledge_base -maxdepth 1 -name 'task_*.py' | wc -l) + 1))
          echo "${{ env.task_payload }}" > "knowledge_base/task_${LESSON_NUM}.py"
          
          cat << EOF > README.md
          # ğŸ¦¾ THE ADAPTIVE CORE (PHOENIX)
          
          ## ğŸ¯ Current Strategy
          - **Objective:** ${{ github.event.inputs.custom_objective }}
          - **Operations Completed:** $LESSON_NUM
          - **Last Sync:** $(date -u)
          
          ## ğŸ› ï¸ Execution Intelligence
          The system has autonomously generated and deployed \`task_${LESSON_NUM}.py\` to the Executor.
          
          ---
          *Self-Evolving System - Powered by Gemini 2.5 & GitHub Actions*
          EOF
          
          git config --global user.name 'Phoenix Core'
          git config --global user.email 'core@phoenix.ai'
          git add .
          git commit -m "Evolution Step $LESSON_NUM"
          git push || echo "Sync failed"

      - name: 5.1 - Continuous Evolution (Recursive Loop)
        if: always()
        run: |
          echo "System cooling down for 300s..."
          sleep 300
          curl -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.COMMANDER_PAT }}" \
            [https://api.github.com/repos/$](https://api.github.com/repos/$){{ github.repository }}/actions/workflows/genesis_commander.yml/dispatches \
            -d '{"ref":"main", "inputs": {"custom_objective": "${{ github.event.inputs.custom_objective }}"}}'