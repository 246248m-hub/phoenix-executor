# -----------------------------------------------------------------
# ğŸ¤– PHOENIX EXECUTOR: The Aware Body (v4)
#
# ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø¢Ù† Ø§Ù„Ø´Ø¹ÙˆØ± Ø¨Ø§Ù„Ø£Ù„Ù… (Ø§Ù„Ø£Ø®Ø·Ø§Ø¡) ÙˆØ§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù†Ù‡ Ø¨Ø§Ù„ØªÙØµÙŠÙ„.
# -----------------------------------------------------------------
name: ğŸ¤– PHOENIX_EXECUTOR_LISTENER (Aware)

on:
  repository_dispatch:
    types: [execute_task]

jobs:
  execute_and_report:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ 1. Ø§Ø³ØªÙ„Ø§Ù… ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù‡Ù…Ø©
        id: prepare_task
        run: |
          echo "EXECUTOR: Command received."
          echo "${{ github.event.client_payload.script }}" | base64 --decode > task_to_execute.py
          echo "EXECUTOR: Task script is ready."
          echo "::set-output name=gemini_key::${{ github.event.client_payload.resources.gemini_api_key }}"
          echo "::set-output name=reporting_token::${{ github.event.client_payload.resources.reporting_token }}"
          echo "EXECUTOR: Temporary resources loaded."

      - name: ğŸ 2. ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ¦Ø© Ø§Ù„ØªÙ†ÙÙŠØ°
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: pip install requests

      - name: ğŸš€ 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ø¹ Ø§Ù„ÙˆØ¹ÙŠ Ø¨Ø§Ù„ÙØ´Ù„
        id: execution
        # continue-on-error: true ÙŠØ³Ù…Ø­ Ù„Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¹Ù…Ù„ Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„Øª Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©
        continue-on-error: true
        env:
          GEMINI_API_KEY: ${{ steps.prepare_task.outputs.gemini_key }}
          GH_TOKEN: ${{ steps.prepare_task.outputs.reporting_token }}
        run: |
          # Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ù‡Ùˆ "Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¹ØµØ¨ÙŠ" Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ù†ÙØ°
          # Ù…Ù‡Ù…ØªÙ‡ Ù‡ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙˆØ§Ù„ØªÙ‚Ø§Ø· Ø£ÙŠ Ø®Ø·Ø£
          
          cat <<'EOF' > runner.py
          import subprocess, sys, json, os, requests, time

          # --- Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ---
          REPORTING_TOKEN = os.environ.get("GH_TOKEN")
          COMMANDER_REPO = "246248m-hub/avatar-template"
          task_id = f"task_{int(time.time())}"

          # --- Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ---
          def send_report(status, details):
              print(f"EXECUTOR: Sending report with status: {status}")
              report_url = f"https://api.github.com/repos/{COMMANDER_REPO}/dispatches"
              report_payload = {
                  "event_type": "task_report",
                  "client_payload": { "task_id": task_id, "status": status, "details": details }
              }
              headers = {"Accept": "application/vnd.github.v3+json", "Authorization": f"token {REPORTING_TOKEN}"}
              try:
                  response = requests.post(report_url, headers=headers, data=json.dumps(report_payload))
                  if response.status_code == 204:
                      print("EXECUTOR: Report sent successfully.")
                  else:
                      print(f"EXECUTOR: FATAL - Failed to send report. Status: {response.status_code}")
              except Exception as e:
                  print(f"EXECUTOR: FATAL - Exception while sending report: {str(e)}")

          # --- Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ù…Ø© ---
          try:
              print("EXECUTOR: Starting task execution...")
              # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© (task_to_execute.py) ÙˆØ§Ù„ØªÙ‚Ø§Ø· Ù…Ø®Ø±Ø¬Ø§ØªÙ‡Ø§ ÙˆØ£Ø®Ø·Ø§Ø¦Ù‡Ø§
              result = subprocess.run(
                  [sys.executable, 'task_to_execute.py'],
                  capture_output=True,
                  text=True,
                  check=True, # Ù‡Ø°Ø§ Ø³ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø¥Ø·Ù„Ø§Ù‚ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª
                  timeout=300 # Ù…Ù‡Ù„Ø© 5 Ø¯Ù‚Ø§Ø¦Ù‚
              )
              print("EXECUTOR: Task completed successfully.")
              # Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
              send_report("success", {"output": result.stdout})

          except subprocess.CalledProcessError as e:
              # Ù‡Ø°Ø§ ÙŠØ¹Ù…Ù„ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª (exit code non-zero)
              print(f"EXECUTOR: Task failed with exit code {e.returncode}.")
              error_details = {
                  "type": "CalledProcessError",
                  "stdout": e.stdout,
                  "stderr": e.stderr
              }
              # Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± ÙØ´Ù„ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
              send_report("failure", error_details)
              # Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø±Ù…Ø² Ø®Ø·Ø£ Ù„Ø¥Ø¹Ù„Ø§Ù… GitHub Ø¨Ø£Ù† Ø§Ù„Ø®Ø·ÙˆØ© ÙØ´Ù„Øª
              sys.exit(1)

          except Exception as e:
              # Ù‡Ø°Ø§ ÙŠØ¹Ù…Ù„ Ù„Ø£ÙŠ Ù†ÙˆØ¹ Ø¢Ø®Ø± Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ (Ù…Ø«Ù„ Timeout)
              print(f"EXECUTOR: An unexpected error occurred: {str(e)}")
              error_details = {"type": "GenericException", "error": str(e)}
              send_report("failure", error_details)
              sys.exit(1)

          EOF
          
          # ØªØ´ØºÙŠÙ„ "Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¹ØµØ¨ÙŠ"
          python runner.py