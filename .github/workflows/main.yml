name: üß¨ GENESIS COMMANDER (The Architect)

on:
  workflow_dispatch:
    inputs:
      custom_objective:
        description: 'Objective'
        required: false
        default: 'Build a modular AI core from scratch: Start with a persistent memory management system and a dynamic execution engine.'

jobs:
  genesis_learning_cycle:
    runs-on: ubuntu-latest
    steps:
      - name: 1.1 - Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMANDER_PAT }}

      - name: 1.2 - Setup
        run: mkdir -p knowledge_base

      - name: 2.1 - Architect Generation (Gemini 2.5)
        id: gemini_task
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          OBJECTIVE: ${{ github.event.inputs.custom_objective }}
        run: |
          KNOWLEDGE=$(find knowledge_base -maxdepth 1 -name 'task_*.py' -print0 | xargs -0 cat 2>/dev/null | tail -c 4000 || echo "Initial State: No core exists yet.")
          
          # ÿ®ÿ±ŸàŸÖÿ®ÿ™ ÿßŸÑÿ®ŸÜÿßÿ° ŸÖŸÜ ÿßŸÑÿµŸÅÿ±
          PROMPT="You are the ARCHITECT AI. 
          OBJECTIVE: $OBJECTIVE
          CURRENT_CORE_FILES: $KNOWLEDGE
          
          Your Task: Write the next Python module for this AI system.
          - DO NOT use pre-trained models (like GPT2/Transformers).
          - Build everything from basic Python logic and standard libraries.
          - Create actual functional components (Memory, Routing, Logic Gates, or Data structures).
          - Respond ONLY with raw Python code. Start with # REQUIREMENTS: if needed."

          JSON_DATA=$(jq -n --arg p "$PROMPT" '{contents: [{parts: [{text: $p}]}]}')
          API_URL="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent"
          
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "x-goog-api-key: ${GOOGLE_API_KEY}" \
            -d "$JSON_DATA" \
            "$API_URL")

          TASK_CODE=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty' | sed -e 's/^```python//' -e 's/^```//' -e 's/```$//' | sed '/./,$!d')

          if [ -z "$TASK_CODE" ] || [ "$TASK_CODE" == "null" ]; then
            echo "‚ùå API Error"
            exit 1
          fi
          
          echo "task_payload<<EOF" >> $GITHUB_ENV
          echo "$TASK_CODE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: 3.1 - Dispatch to Executor
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: executor.yml
          repo: 246248m-hub/phoenix-executor
          token: ${{ secrets.COMMANDER_PAT }}
          inputs: >
            {
              "task_payload": ${{ toJson(env.task_payload) }},
              "commander_repo": "${{ github.repository }}",
              "run_id": "${{ github.run_id }}"
            }

      - name: 4.1 - Update Core Knowledge
        if: success()
        run: |
          NEXT=$(( $(find knowledge_base -maxdepth 1 -name 'task_*.py' | wc -l) + 1 ))
          echo "${{ env.task_payload }}" > "knowledge_base/task_${NEXT}.py"
          git config --global user.name 'Phoenix Architect'
          git config --global user.email 'architect@phoenix.ai'
          git add .
          git commit -m "Core Evolution: Task $NEXT"
          git push || echo "No changes"

      - name: 5.1 - Recursive Loop
        if: always()
        run: |
          sleep 300
          curl -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.COMMANDER_PAT }}" \
            [https://api.github.com/repos/$](https://api.github.com/repos/$){{ github.repository }}/actions/workflows/genesis_commander.yml/dispatches \
            -d '{"ref":"main", "inputs": {"custom_objective": "${{ github.event.inputs.custom_objective }}"}}'