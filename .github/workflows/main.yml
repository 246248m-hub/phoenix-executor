# -----------------------------------------------------------------
# ğŸ¤– PHOENIX EXECUTOR: The Ephemeral Body
#
# Ù…Ù‡Ù…ØªÙ‡: Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ØŒ Ø§Ù„ØªÙ†ÙÙŠØ°ØŒ Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŒ Ø§Ù„Ù…ÙˆØª. Ù„Ø§ ÙŠÙ…Ù„Ùƒ Ø£ÙŠ Ø£Ø³Ø±Ø§Ø±.
# -----------------------------------------------------------------
name: ğŸ¤– PHOENIX_EXECUTOR_LISTENER

on:
  # ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø£Ù…Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ø¯
  repository_dispatch:
    types: [execute_task]

jobs:
  execute_received_task:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ 1. Ø§Ø³ØªÙ„Ø§Ù… ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù‡Ù…Ø©
        id: prepare_task
        run: |
          echo "EXECUTOR: Command received."
          # ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ø³ÙƒØ±Ø¨Øª
          echo "${{ github.event.client_payload.script }}" | base64 --decode > task_to_execute.py
          echo "EXECUTOR: Task script is ready."
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ÙˆØªÙ…Ø±ÙŠØ±Ù‡Ø§ Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
          echo "::set-output name=gemini_key::${{ github.event.client_payload.resources.gemini_api_key }}"
          echo "::set-output name=reporting_token::${{ github.event.client_payload.resources.reporting_token }}"
          echo "EXECUTOR: Temporary resources loaded."

      - name: ğŸ 2. ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ¦Ø© Ø§Ù„ØªÙ†ÙÙŠØ°
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: pip install requests

      - name: ğŸš€ 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©
        env:
          # Ø­Ù‚Ù† Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„ØªÙ†ÙÙŠØ°
          GEMINI_API_KEY: ${{ steps.prepare_task.outputs.gemini_key }}
          GH_TOKEN: ${{ steps.prepare_task.outputs.reporting_token }}
        run: |
          python task_to_execute.py
