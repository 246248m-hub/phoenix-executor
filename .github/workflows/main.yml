name: ğŸ¦¾ UNIVERSAL EXECUTOR (Final Version)

on:
  workflow_dispatch:
    inputs:
      task_payload:
        description: 'The Python code to execute'
        required: true
      commander_repo:
        description: 'The repo of the commander (e.g., user/repo)'
        required: true
      run_id:
        description: 'The original run_id from the commander'
        required: true

jobs:
  execute_universal_task:
    runs-on: ubuntu-latest
    steps:
      # -----------------------------------------------------
      #  Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Ø§Ù„ØªÙ†ÙÙŠØ°
      # -----------------------------------------------------
      - name: 1.1 - Checkout Code (for local tools if any)
        uses: actions/checkout@v4

      - name: 1.2 - Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.10'

      # -----------------------------------------------------
      #  Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø°ÙƒÙŠ ÙˆØ§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
      # -----------------------------------------------------
      - name: 2.1 - Execute Task and Capture Output/Errors
        id: execution
        run: |
          # --- Ø¨Ø¯Ø§ÙŠØ© "Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¹ØµØ¨ÙŠ" Ù„Ù„Ù…Ù†ÙØ° ---
          
          # 1. Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ø¯ ÙˆØ­ÙØ¸Ù‡ ÙÙŠ Ù…Ù„Ù
          echo "EXECUTOR: Task received. Preparing for execution."
          echo "${{ github.event.inputs.task_payload }}" > task_to_run.py

          # 2. (Ø§Ù„Ù…Ø±ÙˆÙ†Ø©) Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯
          # Ù‡Ø°Ø§ ÙŠØ³Ù…Ø­ Ù„Ù„Ù‚Ø§Ø¦Ø¯ Ø¨ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªÙŠ ÙŠØ­ØªØ§Ø¬Ù‡Ø§ Ø§Ù„Ù…Ù†ÙØ°
          if grep -q "# REQUIREMENTS:" task_to_run.py; then
            echo "EXECUTOR: Found requirements directive. Installing libraries..."
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª ÙˆØªØ«Ø¨ÙŠØªÙ‡Ø§
            grep "# REQUIREMENTS:" task_to_run.py | sed 's/# REQUIREMENTS: //' | xargs -r pip install
          fi

          # 3. (Ø§Ù„Ø·Ø§Ø¹Ø© Ø§Ù„Ù…Ø·Ù„Ù‚Ø©) ØªÙ†ÙÙŠØ° Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª ÙˆØ§Ù„Ø£Ø®Ø·Ø§Ø¡
          echo "EXECUTOR: Starting execution..."
          # Ù†Ø³ØªØ®Ø¯Ù… 'bash -c' Ù„Ø§Ù„ØªÙ‚Ø§Ø· ÙƒÙˆØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ (exit code) Ø¨Ø´ÙƒÙ„ Ù…ÙˆØ«ÙˆÙ‚
          # ÙˆÙ†Ù‚ÙˆÙ… Ø¨ØªÙˆØ¬ÙŠÙ‡ Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ø®Ø·Ø£ (stderr) Ø¥Ù„Ù‰ Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ù†Ø¬Ø§Ø­ (stdout)
          EXECUTION_OUTPUT=$(python task_to_run.py 2>&1)
          EXIT_CODE=$?
          
          echo "EXECUTOR: Execution finished with exit code: $EXIT_CODE"

          # 4. (Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙØµÙ„) ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡
          # Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯Ø§Ù‹ ÙØ±ÙŠØ¯Ø§Ù‹ (EOF_MARKER) Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª
          echo "EXECUTION_OUTPUT<<EOF_MARKER" >> $GITHUB_ENV
          echo "$EXECUTION_OUTPUT" >> $GITHUB_ENV
          echo "EOF_MARKER" >> $GITHUB_ENV
          
          echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_ENV
          
          # --- Ù†Ù‡Ø§ÙŠØ© "Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¹ØµØ¨ÙŠ" Ù„Ù„Ù…Ù†ÙØ° ---

      # -----------------------------------------------------
      #  Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ø¯
      # -----------------------------------------------------
      - name: 3.1 - Report Back to Commander
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COMMANDER_PAT }} # Ù…ÙØªØ§Ø­ Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ù„Ù„ØªØ¹Ù„ÙŠÙ‚ ÙÙŠ Ù…Ø³ØªÙˆØ¯Ø¹Ù‡
          script: |
            const commander_repo_parts = "${{ github.event.inputs.commander_repo }}".split('/');
            const owner = commander_repo_parts[0];
            const repo = commander_repo_parts[1];
            const run_id = ${{ github.event.inputs.run_id }};
            
            const exit_code = parseInt(process.env.EXIT_CODE);
            const output = process.env.EXECUTION_OUTPUT;
            
            const status = (exit_code === 0) ? "âœ… SUCCESS" : "âŒ FAILURE";
            
            // ØªØ¬Ù‡ÙŠØ² ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„ ÙˆÙ…Ù†Ø¸Ù…
            const report_body = `
            ## ğŸ¤– UNIVERSAL_EXECUTOR_REPORT ##
            - **Status:** ${status}
            - **Exit Code:** ${exit_code}
            - **Commander Run ID:** ${run_id}
            ---
            ### Full Log:
            \`\`\`
            ${output}
            \`\`\`
            `;

            await github.rest.actions.createWorkflowRunComment({
              owner,
              repo,
              run_id,
              body: report_body
            });
            
            console.log(`EXECUTOR: Report sent back to commander.`);