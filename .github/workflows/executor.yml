name: ğŸ¦¾ UNIVERSAL EXECUTOR

on:
  workflow_dispatch:
    inputs:
      task_payload:
        description: 'Code to run'
        required: true
      commander_repo:
        description: 'Repo of the commander'
        required: true
      run_id:
        description: 'Original run ID'
        required: true

jobs:
  execute:
    runs-on: ubuntu-latest
    steps:
      - name: 1.1 - Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 2.1 - Execute Task
        id: execution
        run: |
          # Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù… ÙÙŠ Ù…Ù„Ù Ù…Ø­Ù„ÙŠ
          cat << 'EOF_PYTHON' > task.py
          ${{ github.event.inputs.task_payload }}
          EOF_PYTHON

          # ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø¥Ø°Ø§ Ø·Ù„Ø¨Ù‡Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¹Ø¨Ø± Ø³Ø·Ø± # REQUIREMENTS:
          if grep -q "# REQUIREMENTS:" task.py; then
            echo "Installing dependencies..."
            pip install $(grep "# REQUIREMENTS:" task.py | cut -d ':' -f 2)
          fi

          # ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª (Ø§Ù„Ù†Ø¬Ø§Ø­ ÙˆØ§Ù„Ø®Ø·Ø£)
          python3 task.py > output.log 2>&1
          EXIT_CODE=$?
          echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_ENV
          
          # ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©)
          echo "LOG_OUTPUT<<EOF" >> $GITHUB_ENV
          cat output.log >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: 3.1 - Report Back to Commander
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COMMANDER_PAT }}
          script: |
            const [owner, repo] = "${{ github.event.inputs.commander_repo }}".split('/');
            const run_id = ${{ github.event.inputs.run_id }};
            const output = process.env.LOG_OUTPUT;
            const status = (process.env.EXIT_CODE == 0) ? "âœ… SUCCESS" : "âŒ FAILURE";

            await github.rest.actions.createWorkflowRunComment({
              owner, repo, run_id,
              body: `### ğŸ¤– ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ†ÙÙŠØ° (Execution Report)\n**Ø§Ù„Ø­Ø§Ù„Ø©:** ${status}\n\n**Ø³Ø¬Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„:**\n\`\`\`\n${output}\n\`\`\``
            });