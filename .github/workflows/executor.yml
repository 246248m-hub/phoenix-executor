name: ğŸ› ï¸ PHOENIX EXECUTOR

on:
  workflow_dispatch:
    inputs:
      task_payload:
        required: true

permissions:
  contents: write
  actions: write

jobs:
  execute:
    runs-on: ubuntu-latest
    steps:
      - name: 1.1 - Decode Thought
        run: |
          echo "${{ github.event.inputs.task_payload }}" | base64 -d > task.py

      - name: 2.1 - Execute & Feedback
        env:
          GH_TOKEN: ${{ secrets.COMMANDER_PAT }}
          SYS_TOKEN: ${{ github.token }}
          OWNER: ${{ github.repository_owner }}
          REPO: "avatar-template"
        run: |
          # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ù…ØªØ§Ø­
          [ -n "$GH_TOKEN" ] && CURRENT_TOKEN="$GH_TOKEN" || CURRENT_TOKEN="$SYS_TOKEN"

          # ØªÙ†ÙÙŠØ° Ø§Ù„ÙƒÙˆØ¯
          python3 task.py > output.log 2> error.log || echo "FAILED" > status.txt
          
          if [ -f status.txt ]; then
            echo "âŒ Failed. Reporting..."
            ERR_B64=$(cat error.log | tail -c 1200 | base64 -w 0)
            # Ø¬Ù„Ø¨ SHA Ù…Ø¹ Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙƒØ³Ø± Ø§Ù„Ø³ÙƒØ±Ø¨Øª (|| echo "null")
            SHA=$(GH_TOKEN=$CURRENT_TOKEN gh api /repos/$OWNER/$REPO/contents/error_log.txt --jq '.sha' 2>/dev/null || echo "null")
            
            if [ "$SHA" == "null" ] || [ -z "$SHA" ]; then
              GH_TOKEN=$CURRENT_TOKEN gh api --method PUT /repos/$OWNER/$REPO/contents/error_log.txt -f message="âš ï¸ Error" -f content="$ERR_B64" || true
            else
              GH_TOKEN=$CURRENT_TOKEN gh api --method PUT /repos/$OWNER/$REPO/contents/error_log.txt -f message="âš ï¸ Update" -f content="$ERR_B64" -f sha="$SHA" || true
            fi
            exit 1
          else
            echo "âœ… Success. Cleaning up error logs safely..."
            # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø³Ø­ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ù…Ø¹ ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ø®Ø·Ø£ Ù†Ø§ØªØ¬ Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            SHA=$(GH_TOKEN=$CURRENT_TOKEN gh api /repos/$OWNER/$REPO/contents/error_log.txt --jq '.sha' 2>/dev/null || echo "null")
            if [ "$SHA" != "null" ] && [ -n "$SHA" ]; then
              GH_TOKEN=$CURRENT_TOKEN gh api --method DELETE /repos/$OWNER/$REPO/contents/error_log.txt -f message="âœ… Clean" -f sha="$SHA" || echo "Already deleted."
            else
              echo "Nothing to clean. Move on."
            fi
            # Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø¶Ø§Ø±Ø¨Ø©: Ù†Ø¶Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù‡Ù…Ø§ Ø­Ø¯Ø« ÙÙŠ Ø®Ø·ÙˆØ© Ø§Ù„ØªÙ†Ø¸ÙŠÙ
            exit 0
          fi