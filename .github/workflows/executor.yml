name: ğŸ¦¾ UNIVERSAL EXECUTOR

on:
  workflow_dispatch:
    inputs:
      task_payload:
        description: 'Code to run'
        required: true
      commander_repo:
        description: 'Repo of the commander'
        required: true
      run_id:
        description: 'Original run ID'
        required: true

jobs:
  execute:
    runs-on: ubuntu-latest
    steps:
      - name: 1.1 - Setup Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 2.1 - Execute Task
        id: execution
        run: |
          # Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…
          cat << 'EOF_PYTHON' > task.py
          ${{ github.event.inputs.task_payload }}
          EOF_PYTHON

          # ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø¥Ø°Ø§ Ø·Ù„Ø¨Ù‡Ø§ Ø§Ù„ÙƒÙˆØ¯
          if grep -q "# REQUIREMENTS:" task.py; then
            echo "Installing dependencies..."
            pip install $(grep "# REQUIREMENTS:" task.py | cut -d ':' -f 2)
          fi

          # Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          python3 task.py > output.log 2>&1
          EXIT_CODE=$?
          echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_ENV
          
          echo "LOG_OUTPUT<<EOF" >> $GITHUB_ENV
          cat output.log >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: 3.1 - Report Back
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COMMANDER_PAT }}
          script: |
            const [owner, repo] = "${{ github.event.inputs.commander_repo }}".split('/');
            const run_id = ${{ github.event.inputs.run_id }};
            const output = process.env.LOG_OUTPUT;
            const status = (process.env.EXIT_CODE == 0) ? "âœ… SUCCESS" : "âŒ FAILURE";

            await github.rest.actions.createWorkflowRunComment({
              owner, repo, run_id,
              body: `### ğŸ¤– Execution Report\n**Status:** ${status}\n\n\`\`\`\n${output}\n\`\`\``
            });