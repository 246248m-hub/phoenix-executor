name: ğŸ› ï¸ PHOENIX EXECUTOR

on:
  workflow_dispatch:
    inputs:
      task_payload:
        description: 'Encoded Python task from Commander'
        required: true

permissions:
  contents: write
  actions: write

jobs:
  execute_task:
    runs-on: ubuntu-latest
    steps:
      # 1. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙˆÙÙƒ ØªØ´ÙÙŠØ± "Ø§Ù„ÙÙƒØ±Ø©" Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ø¹Ù‚Ù„
      - name: 1.1 - Decode Thought
        run: |
          echo "Decoding intelligence payload..."
          echo "${{ github.event.inputs.task_payload }}" | base64 -d > task.py
          if [ ! -s task.py ]; then
            echo "FATAL: Intelligence payload is empty."
            exit 1
          fi

      # 2. Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª
      - name: 2.1 - Execute & Capture
        id: run_script
        env:
          GH_TOKEN: ${{ secrets.COMMANDER_PAT }}
          # ØªÙˆÙƒÙ† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙƒØ®ÙŠØ§Ø± Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø«Ø§Ù†Ù
          SYS_TOKEN: ${{ github.token }}
          OWNER: ${{ github.repository_owner }}
          REPO: "avatar-template"
        run: |
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ØªÙˆÙƒÙ† ÙˆØªÙØ¹ÙŠÙ„Ù‡
          if [ -n "$GH_TOKEN" ]; then
            export CURRENT_TOKEN="$GH_TOKEN"
          else
            export CURRENT_TOKEN="$SYS_TOKEN"
            echo "âš ï¸ Warning: Using fallback System Token."
          fi

          echo "Starting execution of task.py..."
          # ØªÙ†ÙÙŠØ° Ø§Ù„ÙƒÙˆØ¯ ÙˆØ­ÙØ¸ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª ÙˆØ§Ù„Ø£Ø®Ø·Ø§Ø¡
          python3 task.py > output.log 2> error.log || echo "FAILED" > status.txt
          
          # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ø¯ (Ø³ÙˆØ§Ø¡ Ù†Ø¬Ø­ Ø£Ùˆ ÙØ´Ù„)
          if [ -f status.txt ]; then
            echo "âŒ Execution failed. Syncing error log to Commander..."
            ERR_B64=$(cat error.log | tail -c 1200 | base64 -w 0)
            
            # Ø¬Ù„Ø¨ SHA Ù„Ù…Ù„Ù Ø§Ù„Ø®Ø·Ø£ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ù„ØªØ­Ø¯ÙŠØ«Ù‡ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØªÙƒØ±Ø§Ø±Ù‡
            SHA=$(GH_TOKEN=$CURRENT_TOKEN gh api /repos/$OWNER/$REPO/contents/error_log.txt --jq '.sha' || echo "null")
            
            if [ "$SHA" == "null" ]; then
              GH_TOKEN=$CURRENT_TOKEN gh api --method PUT /repos/$OWNER/$REPO/contents/error_log.txt \
                -f message="âš ï¸ Report Failure" -f content="$ERR_B64"
            else
              GH_TOKEN=$CURRENT_TOKEN gh api --method PUT /repos/$OWNER/$REPO/contents/error_log.txt \
                -f message="âš ï¸ Update Failure Log" -f content="$ERR_B64" -f sha="$SHA"
            fi
            exit 1
          else
            echo "âœ… Execution successful. Clearing old error logs from Commander..."
            SHA=$(GH_TOKEN=$CURRENT_TOKEN gh api /repos/$OWNER/$REPO/contents/error_log.txt --jq '.sha' || echo "null")
            if [ "$SHA" != "null" ]; then
              GH_TOKEN=$CURRENT_TOKEN gh api --method DELETE /repos/$OWNER/$REPO/contents/error_log.txt \
                -f message="âœ… Success: Clearing Errors" -f sha="$SHA"
            fi
          fi