name: üõ†Ô∏è PHOENIX EXECUTOR

on:
  workflow_dispatch:
    inputs:
      task_payload:
        required: true

permissions:
  contents: write
  actions: write

jobs:
  execute:
    runs-on: ubuntu-latest
    steps:
      - name: 1.1 - Decode
        run: |
          echo "${{ github.event.inputs.task_payload }}" | base64 -d > task.py

      - name: 2.1 - Run & Report
        env:
          # ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉÿå Ÿàÿ•ÿ∞ÿß ŸÅÿ¥ŸÑ ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿ™ŸàŸÉŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
          MY_TOKEN: ${{ secrets.COMMANDER_PAT }}
          SYS_TOKEN: ${{ github.token }}
          OWNER: ${{ github.repository_owner }}
          REPO: "avatar-template"
        run: |
          # ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿ¥ÿ∫ÿßŸÑ
          if [ -n "$MY_TOKEN" ]; then
            export GH_TOKEN="$MY_TOKEN"
          else
            export GH_TOKEN="$SYS_TOKEN"
            echo "‚ö†Ô∏è Warning: Using default System Token"
          fi

          python3 task.py > output.log 2> error.log || echo "FAILED" > status.txt
          
          if [ -f status.txt ]; then
            echo "‚ö†Ô∏è Reporting error..."
            ERR_B64=$(cat error.log | tail -c 1000 | base64 -w 0)
            SHA=$(gh api /repos/$OWNER/$REPO/contents/error_log.txt --jq '.sha' || echo "null")
            
            if [ "$SHA" == "null" ]; then
              gh api --method PUT /repos/$OWNER/$REPO/contents/error_log.txt -f message="‚ö†Ô∏è Report" -f content="$ERR_B64"
            else
              gh api --method PUT /repos/$OWNER/$REPO/contents/error_log.txt -f message="‚ö†Ô∏è Update" -f content="$ERR_B64" -f sha="$SHA"
            fi
            exit 1
          else
            echo "‚úÖ Success"
            SHA=$(gh api /repos/$OWNER/$REPO/contents/error_log.txt --jq '.sha' || echo "null")
            [ "$SHA" != "null" ] && gh api --method DELETE /repos/$OWNER/$REPO/contents/error_log.txt -f message="‚úÖ Clean" -f sha="$SHA" || true
          fi