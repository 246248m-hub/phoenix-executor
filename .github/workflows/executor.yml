name: ๐๏ธ PHOENIX EXECUTOR (The Resilient Body)

on:
  workflow_dispatch:
    inputs:
      task_payload:
        required: true

jobs:
  execute:
    runs-on: ubuntu-latest
    steps:
      # -----------------------------------------------------
      # 1. ุงุณุชูุจุงู ุงูุฃูุฑ ููู ุชุดููุฑู
      # -----------------------------------------------------
      - name: 1.1 - Decode Order
        run: |
          echo "${{ github.event.inputs.task_payload }}" | base64 -d > task.py
          if [ ! -s task.py ]; then
            echo "FATAL: Payload was empty." > error.log
            exit 1
          fi

      # -----------------------------------------------------
      # 2. ุงูุชูููุฐ ุงูุตุงุฑู ูุงูุชูุงุท ุงููุชุงุฆุฌ
      # -----------------------------------------------------
      - name: 2.1 - Execute & Capture
        id: run_step
        run: |
          # ุชุดุบูู ุงูููุฏ ูุชูุฌูู ูู ุงููุฎุฑุฌุงุช (ุงููุฌุงุญ ูุงูุฎุทุฃ) ุฅูู ูููุงุช ูููุตูุฉ
          # ูุงุณุชุฎุฏุงู '|| export FAILED=true' ูุถูุงู ุงูุชูุงุท ุฃู ูุดู
          python3 task.py > output.log 2> error.log || export FAILED=true
          
          # ุฅุฐุง ูุดู ุงูุชูููุฐุ ูุนุชุจุฑ ุณุฌู ุงูุฎุทุฃ ูู ุงููุฎุฑุฌ ุงูุฑุฆูุณู
          if [ "$FAILED" = "true" ]; then
            mv error.log output.log
          fi

      # -----------------------------------------------------
      # 3. ุงูุฅุจูุงุบ ุงูุตุงุฏู (ุงูุฌุณุฑ ุงูุฌููู)
      # -----------------------------------------------------
      - name: 3.1 - Report Back to Commander
        if: always() # ุงูุฅุจูุงุบ ุฏุงุฆูุงูุ ุณูุงุก ูุฌุญ ุฃู ูุดู
        env:
          GH_TOKEN: ${{ secrets.COMMANDER_PAT }}
          OWNER: ${{ github.repository_owner }}
          # ุงุณุชุจุฏู 'avatar-template' ุจุงูุงุณู ุงููุนูู ููุณุชูุฏุน ุงููุงุฆุฏ ุฅุฐุง ูุงู ูุฎุชููุงู
          COMMANDER_REPO: "avatar-template" 
        run: |
          # ุฅุฐุง ูุงู ููุงู ูุดูุ ุฃุจูุบ ุนู ุงูุฎุทุฃ
          if [ -s error.log ]; then
            # ุชุดููุฑ ุงูุฎุทุฃ ูุฅุฑุณุงูู
            ERR_B64=$(cat error.log | tail -c 1000 | base64 -w 0)
            # ุงูุญุตูู ุนูู SHA ููููู ุงููุฏูู (ุฅุฐุง ูุงู ููุฌูุฏุงู) ูุชุญุฏูุซู
            SHA=$(gh api /repos/$OWNER/$COMMANDER_REPO/contents/error_log.txt --jq '.sha' 2>/dev/null || echo "null")
            
            # ุจูุงุก ุฃูุฑ ุงูุชุญุฏูุซ ุฃู ุงูุฅูุดุงุก
            UPDATE_CMD="gh api --method PUT /repos/$OWNER/$COMMANDER_REPO/contents/error_log.txt -f message='โ๏ธ Report: Execution Failure' -f content='$ERR_B64'"
            if [ "$SHA" != "null" ]; then
              UPDATE_CMD="$UPDATE_CMD -f sha='$SHA'"
            fi
            eval $UPDATE_CMD

          # ุฅุฐุง ูุงู ููุงู ูุฌุงุญุ ุชุฃูุฏ ูู ุฃู ุณุฌู ุงูุฃุฎุทุงุก ูุธูู
          else
            # ุงูุชุญูู ููุง ุฅุฐุง ูุงู ููู ุงูุฃุฎุทุงุก ููุฌูุฏุงู ูู ูุณุชูุฏุน ุงููุงุฆุฏ
            SHA=$(gh api /repos/$OWNER/$COMMANDER_REPO/contents/error_log.txt --jq '.sha' 2>/dev/null || echo "null")
            # ุฅุฐุง ูุงู ููุฌูุฏุงูุ ูู ุจุญุฐูู
            if [ "$SHA" != "null" ]; then
              gh api --method DELETE /repos/$OWNER/$COMMANDER_REPO/contents/error_log.txt -f message='โ Report: Success, Error Log Cleared' -f sha="$SHA"
            fi
          fi
