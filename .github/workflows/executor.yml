name: ğŸ› ï¸ PHOENIX EXECUTOR (The Resilient Body)

on:
  workflow_dispatch:
    inputs:
      task_payload:
        required: true
      run_id:
        required: false

jobs:
  execute:
    runs-on: ubuntu-latest
    steps:
      - name: 1.1 - Checkout
        uses: actions/checkout@v4

      - name: 2.1 - Run & Capture
        id: run_task
        run: |
          echo "${{ github.event.inputs.task_payload }}" | base64 -d > task.py
          # ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ ØµÙŠØ¯ Ø§Ù„Ø®Ø·Ø£
          python3 task.py > output.log 2> error.log || echo "CRASHED" > fail.txt

      - name: 3.1 - Report Back (Self-Healing Bridge)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.COMMANDER_PAT }}
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="avatar-template"
          
          if [ -f fail.txt ]; then
            # Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ´Ù„ Ù„ÙŠØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
            ERR_B64=$(cat error.log | tail -c 1000 | base64 -w 0)
            SHA=$(gh api /repos/$OWNER/$REPO/contents/error_log.txt --jq '.sha' || echo "null")
            
            gh api --method PUT /repos/$OWNER/$REPO/contents/error_log.txt \
              -f message="âš ï¸ Report Error" -f content="$ERR_B64" \
              ${{ (env.SHA != 'null') && format('-f sha={0}', env.SHA) || '' }}
          else
            # ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­ØŒ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            SHA=$(gh api /repos/$OWNER/$REPO/contents/error_log.txt --jq '.sha' || echo "null")
            if [ "$SHA" != "null" ]; then
              gh api --method DELETE /repos/$OWNER/$REPO/contents/error_log.txt \
                -f message="âœ… Success Clean" -f sha="$SHA"
            fi
          fi