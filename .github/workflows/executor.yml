name: ðŸ› ï¸ UNIVERSAL PHOENIX EXECUTOR

on:
  workflow_dispatch:
    inputs:
      task_payload:
        description: 'The code or logic sent by any Commander'
        required: true
      run_id:
        description: 'Reference ID from the Commander'
        required: false

jobs:
  dynamic_execution:
    runs-on: ubuntu-latest
    steps:
      - name: 1.1 - Secure Checkout
        uses: actions/checkout@v4

      - name: 1.2 - Payload Sanitization
        run: |
          # Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø­Ù…ÙˆÙ„Ø© ÙˆØªÙ†Ø¸ÙŠÙÙ‡Ø§ Ù…Ù† Ø£ÙŠ Ø²ÙˆØ§Ø¦Ø¯ Markdown
          echo "${{ github.event.inputs.task_payload }}" > raw_payload.txt
          cat raw_payload.txt | sed -e 's/^```python//' -e 's/^```//' -e 's/```$//' > task.py
          
          if [ ! -s task.py ]; then
            echo "âŒ CRITICAL: Received empty payload!"
            exit 1
          fi

      - name: 2.1 - Auto-Dependency Injection
        run: |
          echo "ðŸ” Analyzing code for required libraries..."
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ imports Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ ÙˆØªØ«Ø¨ÙŠØªÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          IMPORTS=$(grep -E '^(import|from)' task.py | awk '{print $2}' | cut -d. -f1 | sort -u)
          for lib in $IMPORTS; do
            if ! python3 -c "import $lib" 2>/dev/null; then
              echo "ðŸ“¦ Installing missing library: $lib"
              pip install $lib || echo "âš ï¸ Could not install $lib, skipping..."
            fi
          done

      - name: 3.1 - Robust Execution
        id: run_code
        run: |
          echo "ðŸš€ Starting AI Logic Execution..."
          echo "--- EXECUTION OUTPUT ---"
          # ØªØ´ØºÙŠÙ„ Ù…Ø¹ Ø§Ù„ØªÙ‚Ø§Ø· Ø´Ø§Ù…Ù„ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª (Errors + Output)
          python3 -u task.py 2>&1 | tee execution.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "--- END OF OUTPUT ---"
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Logic failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: 4.1 - Adaptive Reporting
        if: always()
        run: |
          echo "### ðŸŒ Universal Executor Report" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ steps.run_code.outputs.status == 'success' && 'âœ… SUCCESS' || 'âŒ FAILED' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commander Run ID:** ${{ github.event.inputs.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **System Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“œ Execution Log:" >> $GITHUB_STEP_SUMMARY
          echo '```python' >> $GITHUB_STEP_SUMMARY
          cat execution.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY