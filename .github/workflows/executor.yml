name: ğŸ› ï¸ PHOENIX EXECUTOR

on:
  workflow_dispatch:
    inputs:
      task_payload:
        required: true

# ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¬ÙˆØ¨
permissions:
  contents: write
  actions: write

jobs:
  execute:
    runs-on: ubuntu-latest
    # ØªØ¹Ø±ÙŠÙ Ø§Ù„ØªÙˆÙƒÙ† Ù‡Ù†Ø§ ÙŠØ¶Ù…Ù† ÙˆØµÙˆÙ„Ù‡ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª
    env:
      GH_TOKEN: ${{ secrets.COMMANDER_PAT }}
      GITHUB_TOKEN: ${{ secrets.COMMANDER_PAT }} 
    steps:
      - name: 1.1 - Decode
        run: |
          echo "${{ github.event.inputs.task_payload }}" | base64 -d > task.py

      - name: 2.1 - Run & Report
        id: run_step
        env:
          OWNER: ${{ github.repository_owner }}
          REPO: "avatar-template"
        run: |
          # Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
          python3 task.py > output.log 2> error.log || echo "FAILED" > status.txt
          
          if [ -f status.txt ]; then
            echo "âš ï¸ Reporting error to Commander..."
            ERR_B64=$(cat error.log | tail -c 1000 | base64 -w 0)
            
            # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ SHA Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ† Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ø£Ù…Ø± ÙƒØ§Ø­ØªÙŠØ§Ø· Ø¥Ø¶Ø§ÙÙŠ
            SHA=$(gh api /repos/$OWNER/$REPO/contents/error_log.txt --jq '.sha' || echo "null")
            
            if [ "$SHA" == "null" ]; then
              gh api --method PUT /repos/$OWNER/$REPO/contents/error_log.txt \
                -f message="âš ï¸ Report Error" -f content="$ERR_B64"
            else
              gh api --method PUT /repos/$OWNER/$REPO/contents/error_log.txt \
                -f message="âš ï¸ Update Error" -f content="$ERR_B64" -f sha="$SHA"
            fi
            exit 1
          else
            echo "âœ… Success. Clearing logs..."
            SHA=$(gh api /repos/$OWNER/$REPO/contents/error_log.txt --jq '.sha' || echo "null")
            if [ "$SHA" != "null" ]; then
              gh api --method DELETE /repos/$OWNER/$REPO/contents/error_log.txt \
                -f message="âœ… Success Clean" -f sha="$SHA"
            fi
          fi