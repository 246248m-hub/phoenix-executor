name: üõ†Ô∏è PHOENIX EXECUTOR
on:
  workflow_dispatch:
    inputs:
      task_payload:
        required: true
jobs:
  execute:
    runs-on: ubuntu-latest
    steps:
      - name: Decode
        run: echo "${{ github.event.inputs.task_payload }}" | base64 -d > task.py
      - name: Run & Report
        env:
          GH_TOKEN: ${{ secrets.COMMANDER_PAT }}
          OWNER: ${{ github.repository_owner }}
        run: |
          python3 task.py > output.log 2> error.log || export FAILED=true
          REPO="avatar-template"
          if [ "$FAILED" = "true" ]; then
            ERR_B64=$(cat error.log | tail -c 1000 | base64 -w 0)
            SHA=$(gh api /repos/$OWNER/$REPO/contents/error_log.txt --jq '.sha' || echo "null")
            gh api --method PUT /repos/$OWNER/$REPO/contents/error_log.txt -f message="‚ö†Ô∏è Report Error" -f content="$ERR_B64" ${{ (env.SHA != 'null') && format('-f sha={0}', env.SHA) || '' }}
            exit 1
          else
            SHA=$(gh api /repos/$OWNER/$REPO/contents/error_log.txt --jq '.sha' || echo "null")
            if [ "$SHA" != "null" ]; then
              gh api --method DELETE /repos/$OWNER/$REPO/contents/error_log.txt -f message="‚úÖ Success Clean" -f sha="$SHA"
            fi
          fi
